# BUILD.md

This document describes the complete build system architecture for the Website Ecosystem.

## Build Philosophy

1. **Separation of Concerns**: Each script has a single, clear responsibility
2. **Intermediate Artifacts**: Build process creates artifacts in `build/` for debugging
3. **Two-Phase Security**: BUILD phase (with secrets) vs PUBLISH phase (redacted)
4. **Dual-Mode Serving**: LOCAL mode (localhost) vs PRODUCTION mode (GitHub Pages)
5. **Clean Builds**: The `build/` directory can be deleted and regenerated
6. **Shell-Formatter Integration**: All scripts use consistent output with shell-formatter.sh

## Critical Build Rules

**CRITICAL**: All build operations MUST follow **[GUARDRAILS.md](./GUARDRAILS.md)**. See:
- **[Critical Warnings](./GUARDRAILS.md#critical-warnings)** for what NEVER to do
- **[Mode Management](./GUARDRAILS.md#mode-management)** for LOCAL vs PRODUCTION
- **[Common Workflows](./GUARDRAILS.md#common-workflows)** for build patterns

**Key Points**:
1. NEVER mix LOCAL and PRODUCTION modes
2. NEVER commit build/ directory
3. ALWAYS use shell-formatter.sh functions
4. ALWAYS validate before building
5. ALWAYS verify redaction before deploy

## Complete Build Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SOURCE    â”‚ --> â”‚   PROCESS    â”‚ --> â”‚   BUILD   â”‚ --> â”‚  PUBLISH â”‚ --> â”‚ DEPLOY â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     (1)                  (2)                 (3)              (4)            (5)
```

### 1. Source Stage (Human-Edited)
```
Input Files:
- getHarsh/config/ecosystem-defaults.yml
- getHarsh/config/schema/*.proto
- [domain].in/config.yml
- blog.[domain].in/config.yml
- [domain].in/[project]/config.yml
- master_posts/*.md
```

### 2. Process Stage (Configuration & Artifacts)
```
Scripts:
- proto2schema.sh      â†’ build/schemas/*.schema.json
- process-configs.sh   â†’ build/configs/[domain]/config.yml
- generate-manifests.sh â†’ build/manifests/[domain]/manifest.json

Key Features:
- Inheritance merging (ecosystem â†’ domain â†’ blog/project)
- Environment variable substitution (BUILD) or redaction (PUBLISH)
- Schema validation at each step
```

### 3. Build Stage (Jekyll)
```
Script: build.sh

Inputs:
- build/configs/[domain]/config.yml (processed configs)
- master_posts/*.md (content)
- getHarsh/templates/* (Jekyll templates)

Outputs:
- [domain]/latest/index.html
- [domain]/latest/manifest.json (copied from build/manifests/)
- [domain]/latest/robots.txt
- [domain]/latest/sitemap.xml
```

### 4. Publish Stage (Finalization)
```
Script: publish.sh

Actions:
- Run verify-redaction.sh on all */latest/ directories
- Move */latest/ â†’ */current/
- Generate deployment report
- Final security verification
```

### 5. Deploy Stage (GitHub Pages)
```
Command: ./version_control.sh push

Result:
- All domains pushed to GitHub
- GitHub Pages serves from default branch
```

## Build Directory Structure

```
getHarsh/build/
â”œâ”€â”€ schemas/                          # JSON Schemas (from Protobuf)
â”‚   â”œâ”€â”€ ecosystem.schema.json         # âœ… Generated by proto2schema.sh
â”‚   â”œâ”€â”€ domain.schema.json           # âœ…
â”‚   â”œâ”€â”€ blog.schema.json             # âœ…
â”‚   â”œâ”€â”€ project.schema.json          # âœ…
â”‚   â””â”€â”€ manifest.schema.json         # âœ…
â”‚
â”œâ”€â”€ configs/                         # Mode-Specific Processed Configurations
â”‚   â”œâ”€â”€ ecosystem-defaults.yml       # Base ecosystem defaults
â”‚   â”œâ”€â”€ getHarsh.in/
â”‚   â”‚   â”œâ”€â”€ local/config.yml        # LOCAL mode: localhost URLs
â”‚   â”‚   â””â”€â”€ production/config.yml   # PRODUCTION mode: domain URLs
â”‚   â”œâ”€â”€ blog.getHarsh.in/
â”‚   â”‚   â”œâ”€â”€ local/config.yml        # LOCAL mode with inheritance
â”‚   â”‚   â””â”€â”€ production/config.yml   # PRODUCTION mode with inheritance
â”‚   â”œâ”€â”€ causality.in/
â”‚   â”‚   â”œâ”€â”€ local/config.yml        # LOCAL mode domain config
â”‚   â”‚   â”œâ”€â”€ production/config.yml   # PRODUCTION mode domain config
â”‚   â”‚   â””â”€â”€ HENA/
â”‚   â”‚       â”œâ”€â”€ local/config.yml    # LOCAL mode project config
â”‚   â”‚       â””â”€â”€ production/config.yml # PRODUCTION mode project config
â”‚   â””â”€â”€ [domain]/...
â”‚
â”œâ”€â”€ manifests/                       # Mode-Specific AI Agent Manifests
â”‚   â”œâ”€â”€ getHarsh.in/
â”‚   â”‚   â”œâ”€â”€ local/manifest.json     # LOCAL mode: localhost ecosystem refs
â”‚   â”‚   â””â”€â”€ production/manifest.json # PRODUCTION mode: domain ecosystem refs
â”‚   â”œâ”€â”€ blog.getHarsh.in/
â”‚   â”‚   â”œâ”€â”€ local/manifest.json
â”‚   â”‚   â””â”€â”€ production/manifest.json
â”‚   â””â”€â”€ [domain]/
â”‚       â”œâ”€â”€ local/manifest.json
â”‚       â””â”€â”€ production/manifest.json
â”‚
â””â”€â”€ logs/                           # Build Process Logs
    â””â”€â”€ YYYY-MM-DD/
        â”œâ”€â”€ process-configs.log
        â”œâ”€â”€ generate-manifests.log
        â”œâ”€â”€ build.log
        â””â”€â”€ publish.log
```

## Script Responsibilities

### Configuration Processing Scripts

1. **proto2schema.sh** âœ…
   - Converts Protobuf â†’ JSON Schema
   - 66 schemas generated successfully
   - Post-processes with proper metadata

2. **validate.sh** âœ…
   - Validates YAML against schema
   - Two-phase validation (BUILD/PUBLISH)
   - End-to-end working with ecosystem-defaults.yml

3. **verify-redaction.sh** âœ…
   - Security validation complete
   - Ensures no secrets in output

4. **process-configs.sh** âœ…
   - Loads and merges configs (inheritance)
   - Mode-aware processing (LOCAL/PRODUCTION)
   - Substitutes environment variables or applies redaction
   - Outputs to build/configs/[domain]/[mode]/

5. **generate-manifests.sh** âœ…
   - Reads processed configs
   - Generates mode-aware AI agent manifests
   - Outputs to build/manifests/[domain]/[mode]/

### Build & Deploy Scripts

6. **build.sh** ðŸš§
   - Runs Jekyll for each domain
   - Uses processed configs
   - Copies manifests to output

7. **publish.sh** ðŸš§
   - Security verification
   - Moves latest â†’ current
   - Prepares for deployment

8. **serve.sh** ðŸš§
   - Local development server
   - Multi-domain support

## Error Handling

Each script returns specific exit codes:
- 0: Success
- 1: General failure
- 2: Invalid arguments
- 3: Missing dependencies
- 4: Validation failure
- 130: User interrupted (Ctrl+C)

## Build Commands

```bash
# One-time setup
./install-dependencies.sh
cd config/tools && ./proto2schema.sh

# LOCAL mode build (development)
./process-configs.sh --mode=LOCAL --phase=BUILD
./generate-manifests.sh --mode=LOCAL
./build.sh --mode=LOCAL
./serve.sh --mode=LOCAL

# PRODUCTION mode build (deployment)
./process-configs.sh --mode=PRODUCTION --phase=PUBLISH
./generate-manifests.sh --mode=PRODUCTION
./build.sh --mode=PRODUCTION
./publish.sh --mode=PRODUCTION
./version_control.sh push

# Quick development testing
./serve.sh --domain=getHarsh.in --mode=LOCAL
```

## Clean Build

```bash
# Remove all build artifacts
rm -rf build/

# Regenerate everything for LOCAL development
./process-configs.sh --mode=LOCAL --phase=BUILD
./generate-manifests.sh --mode=LOCAL
./build.sh --mode=LOCAL

# Or for PRODUCTION deployment
./process-configs.sh --mode=PRODUCTION --phase=PUBLISH
./generate-manifests.sh --mode=PRODUCTION
./build.sh --mode=PRODUCTION
```

This ensures reproducible builds from source.
# BUILD.md

This document describes the complete build system architecture for the Website Ecosystem.

## Build Philosophy

1. **Separation of Concerns**: Each script has a single, clear responsibility
2. **Intermediate Artifacts**: Build process creates artifacts in `build/` for debugging
3. **Two-Phase Security**: BUILD phase (with secrets) vs PUBLISH phase (redacted)
4. **Dual-Mode Serving**: LOCAL mode (localhost) vs PRODUCTION mode (GitHub Pages)
5. **Clean Builds**: The `build/` directory can be deleted and regenerated
6. **Shell-Formatter Integration**: All scripts use consistent output with shell-formatter.sh

## Critical Build Rules

**CRITICAL**: All build operations MUST follow **[GUARDRAILS.md](./GUARDRAILS.md)**. See:
- **[Critical Warnings](./GUARDRAILS.md#critical-warnings)** for what NEVER to do
- **[Mode Management](./GUARDRAILS.md#mode-management)** for LOCAL vs PRODUCTION
- **[Common Workflows](./GUARDRAILS.md#common-workflows)** for build patterns

**Key Points**:
1. NEVER mix LOCAL and PRODUCTION modes
2. NEVER commit build/ directory
3. ALWAYS use shell-formatter.sh functions
4. ALWAYS validate before building
5. ALWAYS verify redaction before deploy

## Complete Build Pipeline

```
┌─────────────┐     ┌──────────────┐     ┌───────────┐     ┌──────────┐     ┌────────┐
│   SOURCE    │ --> │   PROCESS    │ --> │   BUILD   │ --> │  PUBLISH │ --> │ DEPLOY │
└─────────────┘     └──────────────┘     └───────────┘     └──────────┘     └────────┘
     (1)                  (2)                 (3)              (4)            (5)
```

### 1. Source Stage (Human-Edited)
```
Input Files:
- getHarsh/config/ecosystem-defaults.yml
- getHarsh/config/schema/*.proto
- [domain].in/config.yml
- blog.[domain].in/config.yml
- [domain].in/[project]/config.yml
- master_posts/*.md
```

### 2. Process Stage (Configuration & Artifacts)
```
Scripts:
- proto2schema.sh      → build/schemas/*.schema.json
- process-configs.sh   → build/configs/[domain]/config.yml
- generate-manifests.sh → build/manifests/[domain]/manifest.json

Key Features:
- Inheritance merging (ecosystem → domain → blog/project)
- Environment variable substitution (BUILD) or redaction (PUBLISH)
- Schema validation at each step
```

### 3. Build Stage (Jekyll)
```
Script: build.sh

Inputs:
- build/configs/[domain]/config.yml (processed configs)
- master_posts/*.md (content)
- getHarsh/templates/* (Jekyll templates)

Outputs:
- [domain]/latest/index.html
- [domain]/latest/manifest.json (copied from build/manifests/)
- [domain]/latest/robots.txt
- [domain]/latest/sitemap.xml
```

### 4. Publish Stage (Finalization)
```
Script: publish.sh

Actions:
- Run verify-redaction.sh on all */latest/ directories
- Move */latest/ → */current/
- Generate deployment report
- Final security verification
```

### 5. Deploy Stage (GitHub Pages)
```
Command: ./version_control.sh push

Result:
- All domains pushed to GitHub
- GitHub Pages serves from default branch
```

## Build Directory Structure

```
getHarsh/build/
├── schemas/                          # JSON Schemas (from Protobuf)
│   ├── ecosystem.schema.json         # ✅ Generated by proto2schema.sh
│   ├── domain.schema.json           # ✅
│   ├── blog.schema.json             # ✅
│   ├── project.schema.json          # ✅
│   └── manifest.schema.json         # ✅
│
├── configs/                         # Mode-Specific Processed Configurations
│   ├── ecosystem-defaults.yml       # Base ecosystem defaults
│   ├── getHarsh.in/
│   │   ├── local/config.yml        # LOCAL mode: localhost URLs
│   │   └── production/config.yml   # PRODUCTION mode: domain URLs
│   ├── blog.getHarsh.in/
│   │   ├── local/config.yml        # LOCAL mode with inheritance
│   │   └── production/config.yml   # PRODUCTION mode with inheritance
│   ├── causality.in/
│   │   ├── local/config.yml        # LOCAL mode domain config
│   │   ├── production/config.yml   # PRODUCTION mode domain config
│   │   └── HENA/
│   │       ├── local/config.yml    # LOCAL mode project config
│   │       └── production/config.yml # PRODUCTION mode project config
│   └── [domain]/...
│
├── manifests/                       # Mode-Specific AI Agent Manifests
│   ├── getHarsh.in/
│   │   ├── local/manifest.json     # LOCAL mode: localhost ecosystem refs
│   │   └── production/manifest.json # PRODUCTION mode: domain ecosystem refs
│   ├── blog.getHarsh.in/
│   │   ├── local/manifest.json
│   │   └── production/manifest.json
│   └── [domain]/
│       ├── local/manifest.json
│       └── production/manifest.json
│
└── logs/                           # Build Process Logs
    └── YYYY-MM-DD/
        ├── process-configs.log
        ├── generate-manifests.log
        ├── build.log
        └── publish.log
```

## Script Responsibilities

### Configuration Processing Scripts

1. **proto2schema.sh** ✅
   - Converts Protobuf → JSON Schema
   - 66 schemas generated successfully
   - Post-processes with proper metadata

2. **validate.sh** ✅
   - Validates YAML against schema
   - Two-phase validation (BUILD/PUBLISH)
   - End-to-end working with ecosystem-defaults.yml

3. **verify-redaction.sh** ✅
   - Security validation complete
   - Ensures no secrets in output

4. **process-configs.sh** ✅
   - Loads and merges configs (inheritance)
   - Mode-aware processing (LOCAL/PRODUCTION)
   - Substitutes environment variables or applies redaction
   - Outputs to build/configs/[domain]/[mode]/

5. **generate-manifests.sh** ✅
   - Reads processed configs
   - Generates mode-aware AI agent manifests
   - Outputs to build/manifests/[domain]/[mode]/

### Build & Deploy Scripts

6. **build.sh** 🚧
   - Runs Jekyll for each domain
   - Uses processed configs
   - Copies manifests to output

7. **publish.sh** 🚧
   - Security verification
   - Moves latest → current
   - Prepares for deployment

8. **serve.sh** 🚧
   - Local development server
   - Multi-domain support

## Error Handling

Each script returns specific exit codes:
- 0: Success
- 1: General failure
- 2: Invalid arguments
- 3: Missing dependencies
- 4: Validation failure
- 130: User interrupted (Ctrl+C)

## Build Commands

```bash
# One-time setup
./install-dependencies.sh
cd config/tools && ./proto2schema.sh

# LOCAL mode build (development)
./process-configs.sh --mode=LOCAL --phase=BUILD
./generate-manifests.sh --mode=LOCAL
./build.sh --mode=LOCAL
./serve.sh --mode=LOCAL

# PRODUCTION mode build (deployment)
./process-configs.sh --mode=PRODUCTION --phase=PUBLISH
./generate-manifests.sh --mode=PRODUCTION
./build.sh --mode=PRODUCTION
./publish.sh --mode=PRODUCTION
./version_control.sh push

# Quick development testing
./serve.sh --domain=getHarsh.in --mode=LOCAL
```

## Clean Build

```bash
# Remove all build artifacts
rm -rf build/

# Regenerate everything for LOCAL development
./process-configs.sh --mode=LOCAL --phase=BUILD
./generate-manifests.sh --mode=LOCAL
./build.sh --mode=LOCAL

# Or for PRODUCTION deployment
./process-configs.sh --mode=PRODUCTION --phase=PUBLISH
./generate-manifests.sh --mode=PRODUCTION
./build.sh --mode=PRODUCTION
```

This ensures reproducible builds from source.